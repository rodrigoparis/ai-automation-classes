O{
  "name": "Optimización LLM - Batching + Caché (Redis)",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1504,
        2128
      ],
      "id": "974076a4-b497-49e5-b14e-3bb6c835d106",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1skkGrQMg-RfRLaU1hVVzHNMU3o-Srv0-wg01wJGrpoo",
          "mode": "list",
          "cachedResultName": "n8n",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1skkGrQMg-RfRLaU1hVVzHNMU3o-Srv0-wg01wJGrpoo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 659682392,
          "mode": "list",
          "cachedResultName": "Leads",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1skkGrQMg-RfRLaU1hVVzHNMU3o-Srv0-wg01wJGrpoo/edit#gid=659682392"
        },
        "options": {}
      },
      "id": "0aaa87dd-54f9-4ced-969e-836cdfb3f692",
      "name": "Google Sheets - Obtener Leads1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -1280,
        2128
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cWLSasyDmdFoHq1F",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "eRXPxO4iWT66kbKf-9m3r",
          "mode": "list",
          "cachedResultUrl": "/workflow/eRXPxO4iWT66kbKf-9m3r",
          "cachedResultName": "AI Automation Soy Henry — L3 Cost Tracking Sub Execution"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "execution_id": "={{ $execution.id }}",
            "ia_output": "={{ JSON.stringify($json[\"data\"].flatMap(dataset => dataset[\"output\"])) }}",
            "prompt": "Review specific workflow"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "execution_id",
              "displayName": "execution_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ia_output",
              "displayName": "ia_output",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "prompt",
              "displayName": "prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        192,
        1712
      ],
      "id": "8b48dd40-9962-4465-ae25-055bf9bd053b",
      "name": "Call 'results metrics'1"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -64,
        1712
      ],
      "id": "5abd92b9-f12e-4a6e-9672-e6f3457a03c5",
      "name": "Aggregate1"
    },
    {
      "parameters": {
        "jsonSchemaExample": "[\n{\n\"row_number\": 2, \"lead_id\": \"LEAD001\", \"clasificacion\": \"Alto\", \"razon\": \"Explicación concisa en 1 frase\", \"score\": 10\n}\n]\n",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        176,
        2336
      ],
      "id": "7908e0f3-070d-4139-a53b-2b29dbda9e91",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        48,
        2336
      ],
      "id": "b75844fb-265d-4592-8118-8c544449f216",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "j099853ldREEX9te",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        256,
        2544
      ],
      "id": "e2bc1fd6-6c4d-44ab-8832-b52ff72c46a2",
      "name": "Google Gemini Chat Model3",
      "credentials": {
        "googlePalmApi": {
          "id": "j099853ldREEX9te",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -400,
        2112
      ],
      "id": "42628d1c-bfdd-4241-afd5-e4d637609392",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Classify each lead from this batch: {{ JSON.stringify($json.data) }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an expert B2B lead scorer for sales prioritization.\n\nYour task is to:\n1. Analyze each lead in the input array\n2. Classify each lead as High / Medium / Low based on the criteria below\n3. Return a JSON array with the same length as the input\n\nCriteria:\nHIGH (8–10): budget ≥30000 (explicit or implied), mid/large company or funded startup, clear timeline/urgency, technical requirements, decision maker, possible references.\nMEDIUM (5–7): small/medium business or early startup with defined project, clear need without budget, agencies/consultancies, genuine interest without urgency.\nLOW (1–4): generic/low-context request, students/academic, spam/test, no identifiable company, very low budget, not a decision maker.\n\nOUTPUT FORMAT (STRICT JSON):\nReturn an ARRAY with same length as input. Each item must have:\n{\n  \"row_number\": string,\n  \"lead_id\": string,\n  \"clasificacion\": \"Alto\" | \"Medio\" | \"Bajo\",\n  \"razon\": \"1 frase\",\n  \"score\": 1-10\n}\n\nRespond ONLY with the JSON array in Spanish. No extra text. No markdown."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        80,
        2112
      ],
      "id": "ed31b6df-624e-4763-baa2-5d6e9a961f60",
      "name": "Split Agent",
      "retryOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "include": "specifiedFields",
        "fieldsToInclude": "lead_id, mensaje",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -160,
        2128
      ],
      "id": "2284b460-6676-416c-91fa-abc201572c16",
      "name": "Agrupar"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "parsed_data.lead_id",
              "field2": "lead_id"
            }
          ]
        },
        "joinMode": "keepNonMatches",
        "outputDataFrom": "input2",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -624,
        2112
      ],
      "id": "b17a002b-22ef-4cf1-8d7c-8883a20ae53b",
      "name": "Merge"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1skkGrQMg-RfRLaU1hVVzHNMU3o-Srv0-wg01wJGrpoo",
          "mode": "list",
          "cachedResultName": "n8n",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1skkGrQMg-RfRLaU1hVVzHNMU3o-Srv0-wg01wJGrpoo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 659682392,
          "mode": "list",
          "cachedResultName": "Leads",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1skkGrQMg-RfRLaU1hVVzHNMU3o-Srv0-wg01wJGrpoo/edit#gid=659682392"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $json.output.lead_id }}",
            "resultado": "={{ $json.output.razon }}",
            "score": "={{ $json.output.score }}",
            "fecha": "={{ $now.setZone('America/Buenos_Aires')}}",
            "cache_key": "=exec:{{$execution.id}}:{{ $now.format('yy-MM-dd') }}"
          },
          "matchingColumns": [
            "lead_id"
          ],
          "schema": [
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "empresa",
              "displayName": "empresa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensaje",
              "displayName": "mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "resultado",
              "displayName": "resultado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cache_key",
              "displayName": "cache_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        768,
        2112
      ],
      "id": "dc744ed6-82a1-4e3f-acdf-3811bae4a16f",
      "name": "Append or update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cWLSasyDmdFoHq1F",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Split Out').item.json.output.lead_id }}-{{ $json.cache_key }}",
        "value": "={{ JSON.stringify($json) }}  ",
        "keyType": "string",
        "expire": true,
        "ttl": 2500
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        992,
        2288
      ],
      "id": "916b3129-0cb0-4b33-8ce2-6e314fbf6234",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "dvy1eUcK3oHohRmX",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "data",
        "key": "={{ $json.lead_id }}-{{ $json.cache_key }}",
        "keyType": "string",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1056,
        1952
      ],
      "id": "11ee23d6-131b-419b-bcac-941dafcdd824",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "dvy1eUcK3oHohRmX",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        544,
        2112
      ],
      "id": "accbfeeb-c715-46f8-965f-2e1cc8a07a3a",
      "name": "Split Out"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "parsed_data",
              "value": "={{ JSON.parse($json.data) }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "f6fb78c2-52cc-4752-a885-6c4601486a79",
      "name": "Parse JSON String",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -864,
        1952
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Google Sheets - Obtener Leads1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets - Obtener Leads1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          },
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate1": {
      "main": [
        [
          {
            "node": "Call 'results metrics'1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Split Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Split Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agrupar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Agent": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupar": {
      "main": [
        [
          {
            "node": "Split Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "Parse JSON String",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JSON String": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "c507e986-8877-4cfa-a0a5-bd9338da5190",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "47e0ac23754888a751565010093cb153a14e86fc36ec624cb1a41d9cfa067cfb"
  },
  "id": "0CP4MOG5MWskjqEl",
  "tags": [
    {
      "updatedAt": "2026-01-21T00:00:41.377Z",
      "createdAt": "2026-01-21T00:00:41.377Z",
      "id": "NOcIc0doh4AuxaVI",
      "name": "Lecture"
    }
  ]
}